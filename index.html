<!DOCTYPE html>
<html>

<head>
  <title>Call Analysis Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }

    form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      margin: auto;
    }

    input,
    button {
      display: block;
      width: 100%;
      margin-top: 1rem;
      padding: 0.8rem;
    }
  </style>
</head>

<body>
  <form id="call-form">
    <h2>Call Analysis</h2>

    <label for="name">Your Name:</label>
    <input type="text" name="name" id="name"  placeholder="Enter your name" />

    <label for="email">Email:</label>
    <input type="email" name="email" id="email" required placeholder="Enter your email" />

    <label for="phone">Phone Number:</label>
    <input type="tel" name="phone" id="phone" required placeholder="Enter your phone number" />

    <label for="booking_date">Booking Date:</label>
    <input type="date" name="booking_date" id="booking_date" required />

    <label for="summary">Summary:</label>
    <input type="text" name="summary" id="summary"  placeholder="Enter summary" />

    <label for="calltype">Call Type:</label>
    <input type="text" name="calltype" id="calltype" placeholder="Enter call type" />

    <label for="sentiment">Sentiment:</label>
    <input type="text" name="sentiment" id="sentiment" placeholder="Enter sentiment" />

    <label for="qualityScore">Quality Score:</label>
    <input type="number" name="qualityScore" id="qualityScore" placeholder="Enter quality score" />

    <label for="booking_time">Booking Time:</label>
    <input type="time" name="booking_time" id="booking_time" required />

    <label for="audio_file">Upload Call Audio (MP3/WAV):</label>
    <input type="file" name="audio_file" id="audio_file" accept="audio/*" required />

    <button type="submit">Submit for Analysis</button>

    <button id="autofill-btn" style="background:#e0e0e0; color:#333; margin-top:0.5rem;" type="button">Auto fill
      Values</button>
    <button id="submit-autofilled-btn" style="background:#4caf50; color:white; margin-top:0.5rem;" type="button">Submit
      Auto-filled Form</button>

    <div id="response" style="margin-top: 2rem; font-size: 16px; white-space: pre-wrap;"></div>
  </form>

  <script>
    const form = document.getElementById("call-form");
    const responseBox = document.getElementById("response");
    const autofillBtn = document.getElementById("autofill-btn");
    const submitAutofilledBtn = document.getElementById("submit-autofilled-btn");

    let lastResponseData = null;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      responseBox.innerText = "Analyzing call... ðŸ§ ðŸŽ§ Please wait...";

      try {
        const response = await fetch("https://n8n.srv898271.hstgr.cloud/webhook/ec2b9080-f1f4-4dc4-bafc-a91dfb3e59f3", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        lastResponseData = data;
        console.log("Response Data:", data);
        responseBox.innerText = JSON.stringify(data, null, 2);
      } catch (err) {
        responseBox.innerText = "Error: " + err.message;
      }
    });

    autofillBtn.addEventListener("click", () => {
      if (!lastResponseData) {
        responseBox.innerText = "No response data to autofill. Please submit the form first.";
        return;
      }
      // Get all input fields in the form
      const inputs = form.querySelectorAll("input");
      let filled = false;
      inputs.forEach(input => {
        const key = input.name;
        if (key && Object.prototype.hasOwnProperty.call(lastResponseData, key)) {
          // Only fill if value is not undefined/null/empty string
          if (lastResponseData[key] !== undefined && lastResponseData[key] !== null && lastResponseData[key] !== "") {
            input.value = lastResponseData[key];
            filled = true;
          }
        }
      });
      if (!filled) {
        responseBox.innerText = "No matching fields to autofill from response.";
      }
    });

    submitAutofilledBtn.addEventListener("click", async () => {
      // Get form values
      const formFields = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        booking_date: document.getElementById("booking_date").value,
        booking_time: document.getElementById("booking_time").value,
        summary: document.getElementById("summary").value,
        calltype: document.getElementById("calltype").value,
        sentiment: document.getElementById("sentiment").value,
        qualityScore: document.getElementById("qualityScore").value
      };

      // Merge with extra fields from lastResponseData (excluding form fields to avoid overwrite)
      const extraFields = {};
      if (lastResponseData) {
        for (const key in lastResponseData) {
          if (!(key in formFields)) {
            extraFields[key] = lastResponseData[key];
          }
        }
      }

      const payload = { ...formFields, ...extraFields };
      responseBox.innerText = "Submitting auto-filled form...";
      try {
        const resp = await fetch("https://n8n.srv898271.hstgr.cloud/webhook/create-square-booking123", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await resp.json();
        responseBox.innerText = "Auto-filled form submitted!\n" + JSON.stringify(result, null, 2);
      } catch (err) {
        responseBox.innerText = "Error submitting auto-filled form: " + err.message;
      }
    });
  </script>
</body>

</html>